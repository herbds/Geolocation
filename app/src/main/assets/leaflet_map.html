<!DOCTYPE html>
<html>
<head>
    <title>Mapa</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #mapid {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }


        /* Caja de informaci√≥n */
        .info-box {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: Arial, sans-serif;
            display: none;
        }
        .info-box .label {
            font-weight: bold;
            color: #4C1D95;
        }
        .info-box .value {
            color: #333;
            margin-left: 5px;
        }

        /* ‚úÖ NUEVO: Alerta de desviaci√≥n de ruta */
        .route-alert {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            border: 2px solid #EF4444;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #991B1B;
            display: none;
            animation: shake 0.5s ease-in-out;
            max-width: 90%;
        }

        .route-alert.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .route-alert .icon {
            font-size: 1.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-5px); }
            75% { transform: translateX(-50%) translateY(5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body>

<div id="mapid"></div>
<button id="clearBtn" class="clear-destination-btn" onclick="clearDestination()">‚úñ Limpiar Destino</button>

<!-- ‚úÖ NUEVA: Alerta de desviaci√≥n -->
<div id="routeAlert" class="route-alert">
    <span class="icon">‚ö†Ô∏è</span>
    <span id="alertText">Te saliste de la ruta predefinida</span>
</div>

<div id="infoBox" class="info-box">
    <span class="label">Distancia:</span>
    <span class="value" id="distanceText">-</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Captura errores de JS
    window.onerror = function(msg, url, line, col, error) {
        console.error("‚ùå JS ERROR:", msg, "en l√≠nea", line);
        return false;
    };

    console.log("üó∫Ô∏è Inicializando mapa...");

    // Crear mapa centrado en Barranquilla
    var map = L.map('mapid').setView([11.0087601, -74.7943065], 13);
    var currentMarker = null;
    var destinationMarker = null;
    var routeLine = null;

    var currentLocation = null;
    var destinationLocation = null;

    // ‚úÖ NUEVAS: Variables para detecci√≥n de desviaci√≥n
    var routeCoordinates = null; // Almacenar coordenadas de la ruta OSRM
    var isOffRoute = false;
    var offRouteThreshold = 100; // Metros de tolerancia
    var alertTimeout = null;

    // Capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    console.log("‚úÖ Mapa creado");

    // Icono azul para la ubicaci√≥n actual
    var currentIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMyNTYzRUIiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
    });

    // Icono rojo para el destino
    var destinationIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDNDMTEuMDMgMyA3IDcuMDMgNyAxMkM3IDE4Ljc1IDE2IDI5IDE2IDI5QzE2IDI5IDI1IDE4Ljc1IDI1IDEyQzI1IDcuMDMgMjAuOTcgMyAxNiAzWk0xNiAxNUMxNC4zNSAxNSAxMyAxMy42NSAxMyAxMkMxMyAxMC4zNSAxNC4zNSA5IDE2IDlDMTcuNjUgOSAxOSAxMC4zNSAxOSAxMkMxOSAxMy42NSAxNy42NSAxNSAxNiAxNVoiIGZpbGw9IiNFRjQ0NDQiLz4KPC9zdmc+',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
    });

    /**
     * Actualizar la ubicaci√≥n actual desde Android
     */
    function updateLocation(lat, lon) {
        console.log("üìç updateLocation:", lat, lon);
        var newLatLng = L.latLng(lat, lon);
        currentLocation = newLatLng;

        if (currentMarker) {
            currentMarker.setLatLng(newLatLng);
        } else {
            currentMarker = L.marker(newLatLng, {icon: currentIcon}).addTo(map)
                .bindPopup("üìç Mi Ubicaci√≥n");
        }

        map.setView(newLatLng);

        // ‚úÖ NUEVO: Verificar si est√° fuera de ruta
        if (destinationLocation && routeCoordinates) {
            checkIfOffRoute(newLatLng);
        }

        if (destinationLocation) updateRouteLine();

        return "OK";
    }

    /**
     * Establecer destino (llamado desde Android)
     */
    function setDestination(lat, lon) {
        console.log("üéØ setDestination:", lat, lon);
        var destLatLng = L.latLng(lat, lon);
        destinationLocation = destLatLng;

        if (destinationMarker) {
            destinationMarker.setLatLng(destLatLng);
        } else {
            destinationMarker = L.marker(destLatLng, {icon: destinationIcon}).addTo(map)
                .bindPopup("üéØ Destino");
        }

        // Mostrar bot√≥n de limpiar
        document.getElementById('clearBtn').style.display = 'block';

        // Si hay ubicaci√≥n actual, dibujar ruta
        if (currentLocation) {
            updateRouteLine();
        }

        return "OK";
    }

    /**
     * Dibujar ruta por calles usando OSRM
     */
    function updateRouteLine() {
        if (!currentLocation || !destinationLocation) return;

        console.log("üöó Solicitando ruta OSRM...");

        var url = `https://sebastian.tumaquinaya.com/route/v1/driving/` +
            `${currentLocation.lng},${currentLocation.lat};${destinationLocation.lng},${destinationLocation.lat}` +
            `?overview=full&geometries=geojson`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    var route = data.routes[0];
                    var coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // invertir [lon, lat]

                    // ‚úÖ NUEVO: Guardar coordenadas de la ruta para verificaci√≥n
                    routeCoordinates = coords;

                    if (routeLine) map.removeLayer(routeLine);
                    routeLine = L.polyline(coords, {
                        color: '#4C1D95',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);

                    // Mostrar distancia
                    var distanceKm = (route.distance / 1000).toFixed(2);
                    document.getElementById('distanceText').textContent = distanceKm + " km";
                    document.getElementById('infoBox').style.display = 'block';

                    console.log("üìè Ruta calculada correctamente:", distanceKm, "km");
                } else {
                    console.warn("‚ö†Ô∏è No se encontr√≥ ruta OSRM");
                }
            })
            .catch(err => {
                console.error("‚ùå Error al obtener ruta OSRM:", err);
            });
    }

    /**
     * ‚úÖ NUEVA: Verificar si el veh√≠culo se sali√≥ de la ruta
     */
    function checkIfOffRoute(currentPos) {
        if (!routeCoordinates || routeCoordinates.length === 0) {
            return;
        }

        // Calcular la distancia m√≠nima a la ruta
        var minDistance = Infinity;

        for (var i = 0; i < routeCoordinates.length; i++) {
            var routePoint = L.latLng(routeCoordinates[i]);
            var distance = currentPos.distanceTo(routePoint);

            if (distance < minDistance) {
                minDistance = distance;
            }
        }

        console.log(`üìè Distancia a la ruta: ${minDistance.toFixed(2)}m`);

        // Si est√° a m√°s de 50 metros de la ruta
        if (minDistance > offRouteThreshold) {
            if (!isOffRoute) {
                isOffRoute = true;
                showOffRouteAlert();
                notifyAndroid("off_route", minDistance);
            }
        } else {
            if (isOffRoute) {
                isOffRoute = false;
                hideOffRouteAlert();
                notifyAndroid("on_route", minDistance);
            }
        }
    }

    /**
     * ‚úÖ NUEVA: Mostrar alerta de desviaci√≥n
     */
    function showOffRouteAlert() {
        var alert = document.getElementById('routeAlert');
        alert.classList.add('show');

        console.log("‚ö†Ô∏è ALERTA: Te saliste de la ruta");

        // Ocultar autom√°ticamente despu√©s de 5 segundos
        if (alertTimeout) clearTimeout(alertTimeout);
        alertTimeout = setTimeout(function() {
            if (isOffRoute) {
                // Si sigue fuera de ruta, mostrar de nuevo
                alert.classList.remove('show');
                setTimeout(showOffRouteAlert, 100);
            }
        }, 5000);
    }

    /**
     * ‚úÖ NUEVA: Ocultar alerta de desviaci√≥n
     */
    function hideOffRouteAlert() {
        var alert = document.getElementById('routeAlert');
        alert.classList.remove('show');

        if (alertTimeout) {
            clearTimeout(alertTimeout);
            alertTimeout = null;
        }

        console.log("‚úÖ De vuelta en la ruta");
    }

    /**
     * ‚úÖ NUEVA: Notificar a Android sobre el estado de la ruta
     */
    function notifyAndroid(status, distance) {
        try {
            if (window.Android && typeof Android.onRouteStatusChanged === "function") {
                Android.onRouteStatusChanged(status, distance);
            }
        } catch (err) {
            console.error("‚ö†Ô∏è Error notificando a Android:", err);
        }
    }

    /**
     * Limpiar destino
     */
    function clearDestination() {
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        destinationLocation = null;

        // ‚úÖ NUEVO: Limpiar datos de ruta
        routeCoordinates = null;
        isOffRoute = false;
        hideOffRouteAlert();

        document.getElementById('clearBtn').style.display = 'none';
        document.getElementById('infoBox').style.display = 'none';

        if (currentLocation) map.setView(currentLocation, 15);

        console.log("üßπ Destino limpiado");

        // Notificar a Android
        try {
            if (window.Android && typeof Android.onDestinationCleared === "function") {
                Android.onDestinationCleared();
            }
        } catch (err) {
            console.error("‚ö†Ô∏è Error notificando limpieza:", err);
        }

        return "OK";
    }

    console.log("‚úÖ Script cargado y listo");
</script>
</body>
</html>